<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/style-cart.css">
</head>
<body>
    <!-- HEADER -->
    <div class="header-content-cart">
        <div class="head-menubar-cart d-flex align-items-center">
            <div class="container-bg">
                <div class="row">
                    <div class="col-2">
                        <img src="https://cdn.shopify.com/s/files/1/0437/0454/9536/t/26/assets/logo.png?v=8319783983011445918" alt="Logo" srcset="">
                    </div>
                    <div class="col-8">
                        <div class="sidemenu-holder">
                            <nav class="navbar navbar-expand-lg">
                                <div class="collapse navbar-collapse" id="collapsibleNavbar">
                                    <ul class="navbar-nav">
                                        <li class="nav-item">
                                            <a class="nav-link" href="/">Home</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link product" href="/catalog">Catalog</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#">Blog</a>
                                        </li>
                                        <li class="nav-item blog">
                                            <a class="nav-link" href="#">Pages</a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="header-icon">
                            <ul class="list-inline d-flex justify-content-end">
                                <li class="list-inline-item cart">
                                    <a href="/my-cart"><i class="fas fa-shopping-cart fa-lg"></i></a></li>
                                <li class="list-inline-item user" style="margin-inline-end: 40px;">
                                    <a href="/account/login" title="Resister"><i class="far fa-user fa-lg"></i></a>
                                </li>
                                <% if(sess) {%>
                                    <li class="list-inline-item logout">
                                        <a href="/account/logout"><i class="fas fa-sign-out-alt fa-lg"></i></a>
                                    </li>
                                <% } %>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="headphone-image">
        <div class="shopping-cart">
           <h1 style="font-family: 'Times New Roman', Times, serif;">YOUR SHOPPING CART</h1>
           <p>
               <span>
                <a style="color:white" href="/" title="Back to the front page">Home</a>
               </span>
               / Your shopping cart
           </p>
        </div>
    </div>
    <!-- MAIN -->
    <div class="none-product d-none" id="none-product" style="margin:50px; overflow: hidden">
        <div class="container">
            <div class="main" style="padding: 50px 0; text-align: center;">
                <img src="//cdn.shopify.com/s/files/1/0437/0454/9536/t/26/assets/empty-cart.png?v=2503369804438330024" alt="">
                <h5>No Items in cart</h5>
                <p>Add items you want to shop</p>
                <p>
                    <a href="/catalog" class="btn">Start Shopping</a>
                </p>
            </div>
        </div>
    </div>
    <div class="product-list" id="have-product">
        <div class="cart-table">
            <table>
                <colgroup>
                    <col span="1" style="width: 10%;">
                    <col span="1" style="width: 40%;">
                    <col span="1" style="width: 20%;">
                    <col span="1" style="width: 20%;">
                    <col span="1" stlye="width: 10%;">
                 </colgroup>
                </colgroup>
                <tr>
                    <th>Select</th>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                    <th>Remove</th>
                </tr>

                <script>
                    var count;
                    var value;
                    var totalCost = <%= totalCost%>;
                    function plus(id, price){
                        count = ++document.getElementById(id).textContent;
                        value = "$" + count*price;
                        document.getElementById(id + 100).innerHTML = value;
                        totalCost += price;
                        if (checked(id) == false) {
                            // id + 100 is subtoTal
                            // id + 200 is remove
                            // id + 300 is checkbox
                            var nowTotalCost = totalCost - parseInt(document.getElementById(id + 100).textContent.slice(1));
                            document.getElementById("totalCost").innerHTML = "$" + nowTotalCost;
                        } else {
                            document.getElementById("totalCost").innerHTML = "$" + totalCost;
                        }
                        // update in database
                        const idProduct = document.getElementsByClassName("quantity")[id].getAttribute("data-id");
                        const countProduct = document.getElementsByClassName("quantity")[id].textContent;
                        axios.patch('/my-cart/update', {
                                id: idProduct,
                                quantity: countProduct,
                        })
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                        alert("Update successfully!");
                    }
                    function minus(id, price){
                        if (document.getElementById(id).textContent > 1) {
                            count = --document.getElementById(id).textContent;
                            value = "$" + count*price;
                            document.getElementById(id + 100).innerHTML = value;
                            totalCost = totalCost - price;
                            if (checked(id) == false) {
                                // id + 100 is subtoTal
                                // id + 200 is remove
                                // id + 300 is checkbox
                                var nowTotalCost = totalCost - parseInt(document.getElementById(id + 100).textContent.slice(1));
                                document.getElementById("totalCost").innerHTML = "$" + nowTotalCost;
                            } else {
                                document.getElementById("totalCost").innerHTML = "$" + totalCost;
                            }
                            // update in database
                            const idProduct = document.getElementsByClassName("quantity")[id].getAttribute("data-id");
                            const countProduct = document.getElementsByClassName("quantity")[id].textContent;
                            axios.patch('/my-cart/update', {
                                id: idProduct,
                                quantity: countProduct,
                            })
                            .then(function (response) {
                                console.log(response);
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                            alert("Update successfully!");
                        }   
                    }
                    function del(id) {
                        document.getElementById(id + 200).classList.add("d-none");
                        const idProduct = document.getElementsByClassName("quantity")[id].getAttribute("data-id");
                        // const countProduct = document.getElementsByClassName("quantity")[id].textContent;
                        axios.patch('/my-cart/delete', {
                                id: idProduct,
                                quantity: 0,
                        })
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                        alert("Delete successfully!");
                    }
                    function checked(id) {
                        var d = document.getElementById(id + 300) ;
                        if (d.checked) {
                            return true;
                        }
                        return false;
                    }
                </script>
                <% for (var i = 0; i < rows.length; i++){ %>
                    <tr align="center" id="<%= i + 200%>">
                        <td><input type="checkbox" id="<%= i + 300%>" checked></td>
                        <td>
                            <div class="cart-info">
                                <a href="#" class="cart-image">
                                    <img src="<%= rows[i].thumbnail_photo%>">
                                </a>
                                <div class="cart-title">
                                    <a href="" class="product-name h6"><%= rows[i].ProductName %></a>
                                    <br>
                                    <small><%= rows[i].Color %> / <%= rows[i].Material %></small>
                                    <br>
                                    <p>Price: $<%= rows[i].Price %></p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <!-- cái này đúng ko sai đâu đừng xóa -->
                            <input type="button" value="-" class="button" onclick="minus(<%= i%>, <%= rows[i].Price%>)">
                            <!-- <input type="text" value="1" class="quantity" data-id="<%= rows[i].ProductID%>" id="<%= i%>"> -->
                            <div class="quantity" data-id="<%= rows[i].ProductID%>" id="<%= i%>"><%= rows[i].NumProduct %> </div>
                            <input type="button" value="+" class="button" onclick="plus(<%= i%>, <%= rows[i].Price%>)">
                        </td>
                        <td><span id="<%= i + 100%>">$<%= subCost[i]%></span></td>
                        <td><a onclick="del(<%= i %>)"><i class="fa fa-trash"></i></a></td>
                    </tr> 
                <% } %>
            </table>
            <div class="btn-action">
                <a class="btn" href="/catalog">Continue shopping</a>
            </div>
        </div>
        
        <div class="order-summary">
            <p class="title">Order summary</p>
            <p class="price">
                <span class="sub-title h6">Subtotal:</span>
                <span class="sub-total-money h6" id="totalCost">$<%= totalCost %></span>
            </p>
            <div class="btn-action">
                <a class="btn" href="/info">Proceed to checkout</a>
            </div>
            
        </div>
    </div>
    <!-- check if cart = 0 -->
    <script>
        var numOfProduct = <%= rows.length %>;
        if (numOfProduct == 0) {
            document.querySelector("#none-product").classList.remove("d-none");
            document.querySelector("#have-product").classList.add("d-none");
        }
    </script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</body>
</html>